!function(t){"use strict";function i(i){this.$pins=i,this.tasks=[],this.timerId=null,this.deferred=new t.Deferred}function n(t){this.img=t,this.initialWidth=t.width,this.initialHeight=t.height,this.img.isError=!1,this.img.onerror=function(){this.isError=!0}}var e=e||{now:Date.now||function(){return(new Date).getTime()},throttle:function(t,i,n){var s,r,o,a=null,h=0;n||(n={});var l=function(){h=!1===n.leading?0:e.now(),a=null,o=t.apply(s,r),a||(s=r=null)};return function(){var c=e.now();h||!1!==n.leading||(h=c);var u=i-(c-h);return s=this,r=arguments,u<=0||u>i?(a&&(clearTimeout(a),a=null),h=c,o=t.apply(s,r),a||(s=r=null)):a||!1===n.trailing||(a=setTimeout(l,u)),o}},debounce:function(t,i,n){var s,r,o,a,h,l=function(){var c=e.now()-a;c<i&&c>=0?s=setTimeout(l,i-c):(s=null,n||(h=t.apply(o,r),s||(o=r=null)))};return function(){o=this,r=arguments,a=e.now();var c=n&&!s;return s||(s=setTimeout(l,i)),c&&(h=t.apply(o,r),o=r=null),h}}},s=function(i,n){this.$element=t(i),this.options=t.extend({},s.DEFAULTS,n),this.id=Math.random().toString().slice(2),this.$fakePin=null,this.$container=null,this.$pins=null,this.pinWidth=null,this.imgWidth=null,this.lefts=[],this.tops=[],this.init().calculateWidth().calculatePosition().sail(),t(window).on("resize.mystist.waterfall"+this.id,e.debounce(t.proxy(function(){t(window).off("scroll.mystist.waterfall"+this.id),this.calculateWidth().calculatePosition().ship(r.getLoadedPins.call(this))},this),777))};s.VERSION="0.2.8",s.DEFAULTS={},s.prototype.init=function(){return this.initPins().initAttributes(),this},s.prototype.initPins=function(){var i=this.$element.children().length>0?this.$element.children().remove():t(this.$element.data("bootstrap-waterfall-template"));return this.$pins=r.decorate(i),this},s.prototype.initAttributes=function(){return this.$fakePin=this.$pins.first().clone(),this.$container=t("<div />").css("position","relative"),this.$element.html(this.$container),this},s.prototype.calculateWidth=function(){var t=this.$fakePin.clone();return this.$container.append(t.css("opacity",0)),this.pinWidth=t.outerWidth(!0),this.imgWidth=t.find("img:eq(0)").css("width","100%").width(),t.remove(),this},s.prototype.calculatePosition=function(){for(var t=parseInt(this.$container.width()/this.pinWidth,10),i=[],n=[],e=0;e<t;e++)i.push(e*this.pinWidth),n.push(0);return this.lefts=i,this.tops=n,this},s.prototype.sail=function(){var n=r.getToLoadPins.call(this);return new i(n).load().run().deferred.done(t.proxy(function(){this.ship(n)},this)),this},s.prototype.ship=function(i){return this.render(i).updateHeight(),t(window).on("scroll.mystist.waterfall"+this.id,e.throttle(t.proxy(function(){if(r.isWantMore.call(this)){t(window).off("scroll.mystist.waterfall"+this.id),this.sail();var i=r.getRemainingPins.call(this).length;i<=r.getSteps.call(this)&&i>0&&this.$element.trigger("finishing.mystist.waterfall")}},this),500)),this},s.prototype.render=function(i){var n=this;return i.each(function(){n.placePin(t(this))}),this},s.prototype.placePin=function(t){var i=o.indexOf(this.tops,Math.min.apply(null,this.tops)),n=r.getPosition.call(this,i);return t.css({position:"absolute",left:n.left,top:n.top}),t.data("bootstrap-waterfall-pin")&&r.setImageHeight.call(this,t),t.data("bootstrap-waterfall-src")&&(r.makeImageAvailable.call(this,t),t.removeData("bootstrap-waterfall-src")),this.$container.append(t),r.updatePosition.call(this,i,t),this},s.prototype.updateHeight=function(){var t=o.indexOf(this.tops,Math.max.apply(null,this.tops));return this.$container.height(this.tops[t]),this},s.prototype.destroy=function(){return t(window).off("scroll.mystist.waterfall"+this.id),t(window).off("resize.mystist.waterfall"+this.id),this.$element.empty().removeData("mystist.waterfall"),this},s.prototype.addPins=function(i){this.$pins=this.$pins.add(r.decorate(i)),t(window).trigger("scroll.mystist.waterfall"+this.id)};var r={decorate:function(i){return i.map(function(){var i=t(this).find("img:eq(0)");if(i.length>0)return t(this).data("bootstrap-waterfall-src",i.attr("src")),i.attr("src","data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="),this})},getRemainingPins:function(){return this.$pins.map(function(){if(t(this).find("img").length>0&&t(this).data("bootstrap-waterfall-src"))return t(this)})},getSteps:function(){return 3*parseInt(this.$container.width()/this.pinWidth,10)},getToLoadPins:function(){return r.getRemainingPins.call(this).slice(0,r.getSteps.call(this))},getLoadedPins:function(){return this.$pins.map(function(){if(t(this).find("img").length>0&&!t(this).data("bootstrap-waterfall-src"))return t(this)})},isWantMore:function(){return t(window).scrollTop()+t(window).height()>o.getDocHeight()-377},getPosition:function(t){return{left:this.lefts[t],top:this.tops[t]}},setImageHeight:function(t){var i=t.data("bootstrap-waterfall-pin"),n=this.imgWidth*i.img.height/i.img.width;t.find("img:eq(0)").css({height:n,width:"auto"})},makeImageAvailable:function(t){t.find("img:eq(0)").attr("src",t.data("bootstrap-waterfall-src"))},updatePosition:function(t,i){this.tops[t]+=i.outerHeight(!0)}};i.prototype.load=function(){var i=this;return this.$pins.each(function(){var e=new Image;e.src=t(this).data("bootstrap-waterfall-src");var s=new n(e);i.tasks.push(s),t(this).data("bootstrap-waterfall-pin",s)}),this},i.prototype.run=function(){return this.timerId=setInterval(t.proxy(function(){this.isDone()?this.stop():this.check()},this),40),this},i.prototype.isDone=function(){return 0===this.tasks.length},i.prototype.stop=function(){clearInterval(this.timerId),this.timerId=null,this.deferred.resolve()},i.prototype.check=function(){for(var t=0;t<this.tasks.length;t++){this.tasks[t].isLoaded()&&this.tasks.splice(t--,1)}},n.prototype.isLoaded=function(){return!!this.img.isError||this.img.width!==this.initialWidth||this.img.height!==this.initialHeight||this.img.width*this.img.height>1024};var o={getDocHeight:function(){var t=document;return Math.max(t.body.scrollHeight,t.documentElement.scrollHeight,t.body.offsetHeight,t.documentElement.offsetHeight,t.body.clientHeight,t.documentElement.clientHeight)},indexOf:function(t,i){if(null==t)return-1;for(var n=0,e=t.length;n<e;n++)if(t[n]===i)return n;return-1}},a=t.fn.waterfall;t.fn.waterfall=function(i){return this.each(function(){var n=t(this),e=n.data("mystist.waterfall"),r="object"==typeof i&&i;e&&"string"!=typeof i&&e.destroy()&&(e=null),e||n.data("mystist.waterfall",e=new s(this,r)),"string"==typeof i&&e[i]()})},t.fn.waterfall.Constructor=s,t.fn.waterfall.noConflict=function(){return t.fn.waterfall=a,this}}(jQuery);